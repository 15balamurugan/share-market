<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VR Trading Platform</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link rel="icon" href="/static/img/vrlogo.png">
    <style>
        body {
            background-color: #0f3460;
        }
        .chart-container {
            position: relative;
            height: 60vh;
            width: 100%;
            margin-bottom: 30px;
        }
        .dashboard-header {
            background: white;
            color:black;
            padding: 20px 0;
            margin-bottom: 30px;
        }
        .order-panel {
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        .buy-btn {
            background-color: #28a745;
            border: none;
        }
        .sell-btn {
            background-color: #dc3545;
            border: none;
        }
        .nav-pills .nav-link.active {
            background-color: #2abfd3;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <h1>{{title}} Trading Dashboard</h1>
            <p class="mb-0">Complete trading data with candlestick chart and order panel</p>
        </div>
    </div>
    
    <div class="container">
        <div class="card mb-4">
            <div class="card-header">
                <h5>TATA MOTORS Price Movement</h5>
                <div class="form-check form-switch float-end">
                    <input class="form-check-input" type="checkbox" id="showVolumes">
                    <label class="form-check-label" for="showVolumes">Show Volumes</label>
                </div>
            </div>
            <div class="card-body">
                <div class="chart-container" style="height: 500px;">
                    <canvas id="waveChart"></canvas>
                </div>
            </div>
        </div>

        <div class="card order-panel mb-4">
            <div class="card-header">
                <ul class="nav nav-pills">
                    <li class="nav-item">
                        <a class="nav-link active" id="buy-tab" data-bs-toggle="pill" href="#buy-section">Buy</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="sell-tab" data-bs-toggle="pill" href="#sell-section">Sell</a>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="buy-section">
                        <form id="buyForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Stock</label>
                                    <input type="text" class="form-control" value="TATA MOTORS" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Current Price</label>
                                    <input type="text" class="form-control" id="currentPrice" value="₹450.25" readonly>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Order Type</label>
                                    <select class="form-select" id="buyOrderType">
                                        <option value="market">Market Order</option>
                                        <option value="limit">Limit Order</option>
                                        <option value="sl">Stop Loss (SL)</option>
                                        <option value="slm">Stop Loss Market (SL-M)</option>
                                    </select>
                                </div>
                                <div class="col-md-6" id="buyPriceContainer">
                                    <label class="form-label" id="buyPriceLabel">Limit Price</label>
                                    <input type="number" class="form-control" id="buyPrice" step="0.01">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="buyQty" min="1" value="1">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Duration</label>
                                    <select class="form-select" id="buyDuration">
                                        <option value="intraday">Intraday</option>
                                        <option value="longterm" selected>Longterm</option>
                                        <option value="midterm">midterm</option>
                                        <option value="position">position</option>
                                        <option value="shortterm">shortterm</option>
                                        <option value="swing">swing</option>

                                    </select>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success buy-btn">Buy TATA MOTORS</button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="tab-pane fade" id="sell-section">
                        <form id="sellForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Stock</label>
                                    <input type="text" class="form-control" value="TATA MOTORS" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Current Price</label>
                                    <input type="text" class="form-control" id="sellCurrentPrice" value="₹450.25" readonly>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Order Type</label>
                                    <select class="form-select" id="sellOrderType">
                                        <option value="market">Market Order</option>
                                        <option value="limit">Limit Order</option>
                                        <option value="sl">Stop Loss (SL)</option>
                                        <option value="slm">Stop Loss Market (SL-M)</option>
                                    </select>
                                </div>
                                <div class="col-md-6" id="sellPriceContainer">
                                    <label class="form-label" id="sellPriceLabel">Limit Price</label>
                                    <input type="number" class="form-control" id="sellPrice" step="0.01">
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label">Quantity</label>
                                    <input type="number" class="form-control" id="sellQty" min="1" value="1">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Holding Qty</label>
                                    <input type="text" class="form-control" value="25 shares" readonly>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-danger sell-btn">Sell TATA MOTORS</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial"></script>
    <script src="https://cdn.jsdelivr.net/npm/technicalindicators@3.1.0/dist/browser/technicalindicators.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/luxon@3.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-luxon@1.2.0"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let waveChart;

        document.getElementById('buyOrderType').addEventListener('change', function() {
            updatePriceField('buy', this.value);
        });
        
        document.getElementById('sellOrderType').addEventListener('change', function() {
            updatePriceField('sell', this.value);
        });

        function updatePriceField(type, orderType) {
            const container = document.getElementById(`${type}PriceContainer`);
            const label = document.getElementById(`${type}PriceLabel`);
            const input = document.getElementById(`${type}Price`);
            
            switch(orderType) {
                case 'market':
                    container.style.display = 'none';
                    break;
                case 'limit':
                    container.style.display = 'block';
                    label.textContent = 'Limit Price';
                    input.placeholder = 'Enter limit price';
                    break;
                case 'sl':
                case 'slm':
                    container.style.display = 'block';
                    label.textContent = 'Trigger Price';
                    input.placeholder = 'Enter trigger price';
                    break;
            }
        }

        document.getElementById('buyForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const orderType = document.getElementById('buyOrderType').value;
            const qty = document.getElementById('buyQty').value;
            const price = orderType === 'market' ? 'Market Price' : document.getElementById('buyPrice').value;
            
            alert(`Buy Order Placed!\nType: ${orderType.toUpperCase()}\nQty: ${qty}\nPrice: ${price}`);
        });

        document.getElementById('sellForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const orderType = document.getElementById('sellOrderType').value;
            const qty = document.getElementById('sellQty').value;
            const price = orderType === 'market' ? 'Market Price' : document.getElementById('sellPrice').value;
            
            alert(`Sell Order Placed!\nType: ${orderType.toUpperCase()}\nQty: ${qty}\nPrice: ${price}`);
        });

        document.addEventListener('DOMContentLoaded', function() {
            updatePriceField('buy', 'limit');
            updatePriceField('sell', 'limit');
            loadWaveChart();
        });

        async function loadWaveChart() {
            try {
                const response = await fetch('/api/tata_motors/price_movement');
                const data = await response.json();
                renderWaveChart(data);
            } catch (error) {
                console.error("Error loading chart data:", error);
            }
        }

        function renderWaveChart(data) {
            const ctx = document.getElementById('waveChart').getContext('2d');
            
            if (waveChart) {
                waveChart.destroy();
            }
            
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(58, 123, 213, 0.8)');
            gradient.addColorStop(1, 'rgba(58, 123, 213, 0.1)');
            
            const chartData = {
                labels: data.dates,
                datasets: [
                    {
                        label: 'Price Movement',
                        data: data.closes,
                        borderColor: '#3a7bd5',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        tension: 0.4,
                        fill: true,
                        pointRadius: 0,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Daily High',
                        data: data.highs,
                        borderColor: '#4CAF50',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Daily Low',
                        data: data.lows,
                        borderColor: '#F44336',
                        borderWidth: 1,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Volume',
                        data: data.volumes,
                        backgroundColor: 'rgba(120, 144, 156, 0.2)',
                        borderColor: 'rgba(120, 144, 156, 0.8)',
                        borderWidth: 1,
                        type: 'bar',
                        yAxisID: 'y1',
                        hidden: true
                    }
                ]
            };
            
            waveChart = new Chart(ctx, {
                type:'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                maxRotation: 45,
                                minRotation: 45
                            }
                        },
                        y: {
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Price (₹)'
                            }
                        },
                        y1: {
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Volume'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        if (context.dataset.label !== 'Volume') {
                                            label += '₹' + context.parsed.y.toFixed(2);
                                        } else {
                                            label += context.parsed.y.toLocaleString();
                                        }
                                    }
                                    return label;
                                },
                                afterLabel: function(context) {
                                    const index = context.dataIndex;
                                    return `Open: ₹${data.opens[index].toFixed(2)}\n` +
                                        `High: ₹${data.highs[index].toFixed(2)}\n` +
                                        `Low: ₹${data.lows[index].toFixed(2)}\n` +
                                        `Close: ₹${data.closes[index].toFixed(2)}`;
                                }
                            }
                        }
                    }
                }
            });
            
            document.getElementById('showVolumes').addEventListener('change', function() {
                const volDataset = waveChart.getDatasetMeta(3);
                volDataset.hidden = !this.checked;
                waveChart.update();
            });
        }
    </script>
</body>
</html>